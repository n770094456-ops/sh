<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช - ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ======================================================= */
        /* 1. ุงูุชูุณูู ุงูุฃุณุงุณู                                     */
        /* ======================================================= */
        :root {
            --light-bg: #f8f9fa; 
            --light-primary: #007bff; 
            --light-secondary: #ffffff; 
            --light-text: #343a40; 
            --light-card-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            --light-hover-bg: #e9ecef;
            --light-danger: #dc3545;
            --light-success: #28a745;
            --light-warning: #ffc107;
            --light-info: #17a2b8;
            --font-sm: 13px;
            --font-md: 15px;
        }
        /* ุงูุชุญุฏูุซุงุช ููุง ูุชุตุจุญ ูุทุงุจูุฉ ูู login.html */
        .dark-mode {
            --light-bg: #0D1117; /* ุฎูููุฉ GitHub */
            --light-primary: #58A6FF; /* ุฃุฒุฑู GitHub */
            --light-secondary: #161B22; /* ุฎูููุฉ ุงูุตูุฏูู */
            --light-text: #C9D1D9; /* ููู ุงููุต */
            --light-card-shadow: 0 3px 10px rgba(0, 0, 0, 0.5); 
            --light-hover-bg: #2B3035; 
            --light-danger: #f85149; 
            --light-success: #3fb950; 
            --light-warning: #d29922;
            --light-info: #4cbae6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: background-color 0.3s, color 0.3s;
            direction: rtl;
        }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        h1 { margin-bottom: 20px; color: var(--light-primary); font-size: 24px; }
        h2 { margin-top: 30px; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid var(--light-hover-bg); padding-bottom: 5px; }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: var(--font-sm);
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-sm {
             padding: 6px 10px;
             font-size: 12px;
        }
        .btn-primary { background-color: var(--light-primary); color: var(--light-secondary); }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-danger { background-color: var(--light-danger); color: var(--light-secondary); }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: var(--light-success); color: var(--light-secondary); }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-info { background-color: var(--light-info); color: var(--light-secondary); } 
        .btn-info:hover { background-color: #138496; }

        /* ======================================================= */
        /* 2. ุชูุธูู ูููุฐุฌ ุงูุฅุถุงูุฉ/ุงูุชุนุฏูู (ุงูุดุจูุฉ)                 */
        /* ======================================================= */
        #product-form {
            background-color: var(--light-secondary);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--light-card-shadow);
            margin-bottom: 30px;
            display: grid;
            gap: 20px; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { margin-bottom: 5px; font-size: var(--font-sm); font-weight: bold; }
        input, select, textarea {
            padding: 10px;
            border: 1px solid var(--light-hover-bg);
            border-radius: 4px;
            background-color: var(--light-bg);
            color: var(--light-text);
            font-size: var(--font-md);
        }
        .dark-mode input, .dark-mode select, .dark-mode textarea {
            background-color: #2b3035;
            border-color: #3b4249;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--light-hover-bg); 
            outline: none; 
            box-shadow: none; 
        }

        /* ======================================================= */
        /* 3. ุชูุณูู ูุงุฆูุฉ ุงูููุชุฌุงุช                               */
        /* ======================================================= */
        #product-list { display: grid; gap: 10px; grid-template-columns: 1fr; }
        .product-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--light-secondary);
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .product-item .actions { display: flex; gap: 10px; }
        .item-details { flex-grow: 1; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; } 

        .product-item .price-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            margin-right: 15px;
            min-width: 100px;
        }
        .product-item .original-price {
            text-decoration: line-through;
            color: #a0a0a0;
            font-size: var(--font-sm);
        }
        .product-item .discounted-price {
            color: var(--light-danger); 
            font-weight: bold;
            font-size: var(--font-md);
        }
        .discount-badge {
            background-color: var(--light-danger); 
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
            margin-left: 5px;
        }
        .dark-mode .discount-badge {
            background-color: var(--light-danger);
        }
        /* ------------------------------------------- */


        /* ======================================================= */
        /* 4. ุฅุฎูุงุก ุงููุญุชูู ูุจู ุงูุชุญูู ูู ุงูุฏุฎูู/ูุถุน ุงูููู       */
        /* ======================================================= */
        .hidden-content { display: none !important; }
        .auth-check-message { text-align: center; padding: 50px; color: var(--light-primary); }
        
        .is-locked {
            opacity: 0.5; 
            pointer-events: none; 
            filter: blur(2px); 
        }

        /* ======================================================= */
        /* 5. ุชูุณูู ูุฏุฎูุงุช ุงูุตูุฑุฉ (ููุชูุธูู)                       */
        /* ======================================================= */
        .image-mode-switch { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
        }
        .image-mode-switch .btn {
            flex-grow: 1;
            padding: 8px;
            font-size: var(--font-sm);
        }
        
        /* ======================================================= */
        /* 6. ุชูุณูู ุงูุฅุดุนุงุฑุงุช ุงูุนุงุฆูุฉ (Notification)              */
        /* ======================================================= */
        #notification-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 10000;
            max-width: 350px;
        }
        .notification-item {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease-in-out;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            direction: rtl;
            cursor: pointer; /* ๐ ูููุณุฉ ุฌุฏูุฏุฉ */
        }
        .notification-item.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification-success { background-color: var(--light-success); color: white; }
        .notification-error { background-color: var(--light-danger); color: white; }
        .notification-warning { background-color: var(--light-warning); color: var(--light-text); }
        .notification-info { background-color: var(--light-info); color: white; }
        .notification-item i { font-size: 18px; }
        
        /* ======================================================= */
        /* 7. ุชูุณูู ุดุงุดุฉ ุงูุชุญุฐูุฑ ุงูุฌุฏูุฏุฉ (Inactivity)              */
        /* ======================================================= */
        #inactivity-warning {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.7); 
            z-index: 9999; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            text-align: center;
            transition: all 0.3s;
        }
        
        #inactivity-warning > div {
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); 
            max-width: 450px; 
            width: 90%;
            background-color: var(--light-secondary); 
            color: var(--light-text);
        }


        @media (max-width: 768px) {
            #product-form { grid-template-columns: 1fr; }
            .product-item { flex-wrap: wrap; }
            .item-details { width: 100%; margin-bottom: 10px; }
            .product-item .actions { width: 100%; justify-content: flex-end; }
            #notification-container {
                left: 15px;
                max-width: 90%;
            }
        }

        /* ุชูุณูู ุดุงุดุฉ ุงูุชุฃููุฏ ุงูุฎุงุตุฉ ุจุงูุงุณุชุนุงุฏุฉ */
        #backup-confirmation-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            display: none;
            justify-content: center;
            align-items: center;
        }
        #backup-confirmation-modal > div {
            background-color: var(--light-secondary);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--light-card-shadow);
            width: 350px;
            text-align: center;
            color: var(--light-text);
        }
        #backup-confirmation-modal h3 {
            margin-top: 0;
            color: var(--light-warning);
        }
        #backup-confirmation-modal button {
            margin: 10px 5px 0;
        }
        
        /* ๐ ุชูุณูู ุดุงุดุฉ ุชุฃููุฏ ุงูุฎุฑูุฌ (Simplified Logout Prompt) */
        #logout-confirmation-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 10003;
            display: none;
            justify-content: center;
            align-items: center;
        }
        #logout-confirmation-modal > div {
            background-color: var(--light-secondary);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--light-card-shadow);
            width: 350px;
            text-align: center;
            color: var(--light-text);
        }
        #logout-confirmation-modal button {
            margin: 10px 5px 0;
        }


        /* ุชูุณูู ุดุงุดุฉ ุฑูุฒ ุงูุชุฃููุฏ */
        #pin-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10002; 
            display: none;
            justify-content: center;
            align-items: center;
        }
        #pin-modal > div {
            background-color: var(--light-secondary);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
            width: 300px;
            text-align: center;
            color: var(--light-text);
        }
        #pin-modal input {
            width: 100%;
            margin-bottom: 15px;
            text-align: center;
            letter-spacing: 5px;
            font-weight: bold;
        }
        
        /* ๐ ุชูุณูู ุดุงุดุฉ ุชุฃููุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุงูุฌุฏูุฏุฉ */
        #backup-prompt-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 10004;
            display: none;
            justify-content: center;
            align-items: center;
        }
        #backup-prompt-modal > div {
            background-color: var(--light-secondary);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--light-card-shadow);
            width: 350px;
            text-align: center;
            color: var(--light-text);
        }
        #backup-prompt-modal button {
            margin: 10px 5px 0;
        }
        
        /* ๐ ุชูุณูู ุดุงุดุฉ ุชุฃููุฏ ุงูุญุฐู (New Delete Confirmation) */
        #delete-confirmation-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 10005; /* higher than other modals */
            display: none;
            justify-content: center;
            align-items: center;
        }
        #delete-confirmation-modal > div {
            background-color: var(--light-secondary);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.4); /* Danger color shadow */
            width: 380px;
            text-align: center;
            color: var(--light-text);
        }
        #delete-confirmation-modal h3 {
            color: var(--light-danger);
            margin-bottom: 10px;
        }
        #delete-confirmation-modal p {
            margin-bottom: 20px;
            font-size: var(--font-md);
        }
        #delete-confirmation-modal button {
            margin: 10px 5px 0;
        }

    </style>
</head>
<body>

    <div id="notification-container"></div>
    
    <div id="backup-confirmation-modal">
        <div>
            <i class="fas fa-question-circle" style="font-size: 30px; color: var(--light-warning); margin-bottom: 10px;"></i>
            <h3 id="confirmation-title">ุชุญุฏูุซ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</h3>
            <p id="confirmation-message">ูู ุชุฑูุฏ ุชุญุฏูุซ ูุณุฎุฉ ุงูููุชุฌุงุช ุงููุญููุธุฉ ูู ุงููุชุตูุญ ุญุงููุงู (${currentCount}) ุจุงูููุชุฌุงุช ุงูุชู ุชู ุงุณุชุนุงุฏุชูุง (${newCount})ุ ุณูุชู ุงูุชุญุฏูุซ ุชููุงุฆูุงู ุจุนุฏ 10 ุซูุงูู.</p>
            <button class="btn btn-success" id="confirm-backup-yes"><i class="fas fa-check"></i> ูุนูุ ูู ุจุงูุชุญุฏูุซ ุงูุขู</button>
            <button class="btn btn-danger" id="confirm-backup-no"><i class="fas fa-times"></i> ูุงุ ุฃุจูู ุงููุณุฎุฉ ุงูุญุงููุฉ</button>
            <small id="countdown-backup-message" style="display: block; margin-top: 10px; color: var(--light-info);"></small>
        </div>
    </div>
    
    <div id="logout-confirmation-modal" style="display: none;">
        <div>
            <i class="fas fa-sign-out-alt" style="font-size: 30px; color: var(--light-danger); margin-bottom: 10px;"></i>
            <h3>ุชุฃููุฏ ุชุณุฌูู ุงูุฎุฑูุฌ</h3>
            <p style="font-size: var(--font-sm); margin-bottom: 20px;">ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌุ</p>
            <button class="btn btn-danger" id="confirm-logout-direct" style="margin-right: 5px;"><i class="fas fa-sign-out-alt"></i> ุชุณุฌูู ุงูุฎุฑูุฌ</button>
            <button class="btn btn-info" id="confirm-logout-cancel"><i class="fas fa-times"></i> ุฅูุบุงุก</button>
        </div>
    </div>

    <div id="pin-modal">
        <div>
            <i class="fas fa-lock" style="font-size: 30px; color: var(--light-primary); margin-bottom: 15px;"></i>
            <h3>ุฑูุฒ ุงูุชุฃููุฏ ูุทููุจ</h3>
            <p id="pin-message" style="font-size: var(--font-sm); margin-bottom: 10px;">ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูุฒ ุชุฃููุฏ ุงูุฅุฏุงุฑุฉ ูููุชุงุจุนุฉ.</p>
            <input type="password" id="pin-input" maxlength="6" placeholder="******">
            <button class="btn btn-primary" id="pin-submit-btn"><i class="fas fa-sign-in-alt"></i> ุชุฃููุฏ</button>
        </div>
    </div>
    
    <div id="backup-prompt-modal" style="display: none;">
        <div>
            <i class="fas fa-question-circle" style="font-size: 30px; color: var(--light-info); margin-bottom: 10px;"></i>
            <h3>ูู ุชุฑูุฏ ุชูุฒูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ (JSON)ุ</h3>
            <p id="prompt-message" style="font-size: var(--font-sm); margin-bottom: 20px;">
                ุชู ุญูุธ ุงูุชุบููุฑุงุช ูู ุงููุชุตูุญ ุจูุฌุงุญ. ูุฑุฌู ุชูุฒูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุงูุขู ูุญูุธ ุงูุชุบููุฑุงุช ูู ููู ุฎุงุฑุฌู.
            </p>
            <button class="btn btn-success" id="confirm-backup-prompt-yes" style="margin-right: 5px;"><i class="fas fa-cloud-download-alt"></i> ูุนูุ ูู ุจุงูุชูุฒูู ุงูุขู</button>
            <button class="btn btn-info" id="confirm-backup-prompt-no"><i class="fas fa-times"></i> ูุงุ ุดูุฑุงู</button>
        </div>
    </div>
    
    <div id="delete-confirmation-modal" style="display: none;">
        <div>
            <i class="fas fa-trash-alt" style="font-size: 40px; color: var(--light-danger); margin-bottom: 15px;"></i>
            <h3>ุชุฃููุฏ ุญุฐู ุงูููุชุฌ</h3>
            <p id="delete-confirmation-message">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููุชุฌ "<strong id="product-name-to-delete"></strong>" ููุงุฆูุงูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
            <button class="btn btn-danger" id="confirm-delete-yes"><i class="fas fa-trash"></i> ูุนูุ ุชุฃููุฏ ุงูุญุฐู</button>
            <button class="btn btn-info" id="confirm-delete-no"><i class="fas fa-times"></i> ุฅูุบุงุก</button>
        </div>
    </div>


    <div id="auth-message" class="auth-check-message">
        <p>ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑุ ุฌุงุฑู ุงูุชุญูู ูู ุญุงูุฉ ุชุณุฌูู ุงูุฏุฎูู...</p>
    </div>
    
    <div id="admin-content" class="hidden-content">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <a href="products.html" style="text-decoration: none; color: var(--light-primary); font-size: var(--font-md);"><i class="fas fa-arrow-right"></i> ุงูุนูุฏุฉ ูููุชุฌุฑ</a>
                <div>
                    <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ุชุณุฌูู ุฎุฑูุฌ</button>
                    <button class="btn" id="mode-toggle" style="background: transparent; color: var(--light-text); border: 1px solid var(--light-hover-bg);"><i class="fas fa-moon"></i> ุงููุถุน</button>
                </div>
            </div>
            
            <h1 id="page-title">ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ ๐</h1>

            <form id="product-form">
                <input type="hidden" id="product-id-to-edit">
                
                <div class="form-group"> <label for="product-name">ุงุณู ุงูููุชุฌ:</label> <input type="text" id="product-name" required> </div>
                <div class="form-group"> <label for="product-price">ุงูุณุนุฑ ุงูุฃุตูู:</label> <input type="number" id="product-price" required min="0.01" step="0.01"> </div>
                
                <div class="form-group"> 
                    <label>ุฅุนุฏุงุฏ ุงูุฎุตู:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-sm btn-primary" id="discount-mode-percent" data-mode="percent"><i class="fas fa-percent"></i> ูุณุจุฉ ุงูุฎุตู (%)</button>
                        <button type="button" class="btn btn-sm" id="discount-mode-price" data-mode="price-after"><i class="fas fa-tag"></i> ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู</button>
                    </div>
                    
                    <div id="discount-percent-group">
                        <label for="product-discount-percent" style="font-size: var(--font-sm); font-weight: normal;">ูุณุจุฉ ุงูุฎุตู (%):</label> 
                        <input type="number" id="product-discount-percent" value="0" min="0" max="100" step="0.01" placeholder="ูุณุจุฉ ูุฆููุฉ (ูุซู 10.5)" oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4); handleDiscountChange(this, 'percent');"> 
                    </div>

                    <div id="discount-price-group" style="display:none;">
                        <label for="product-discount-price" style="font-size: var(--font-sm); font-weight: normal;">ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู:</label> 
                        <input type="number" id="product-discount-price" value="" min="0.01" step="0.01" placeholder="ูููุฉ ุงูุณุนุฑ ุงูุฌุฏูุฏุฉ" oninput="handleDiscountChange(this, 'price-after');"> 
                    </div>
                    <small id="discount-auto-calc-message" style="color: var(--light-info); font-size: 11px; margin-top: 5px; text-align: right;"></small>
                </div> 

                
                <div class="form-group"> <label for="product-currency">ุงูุนููุฉ:</label>
                    <select id="product-currency" required>
                        <option value="YER">ุฑูุงู ูููู (YER)</option>
                        <option value="SAR">ุฑูุงู ุณุนูุฏู (SAR)</option>
                        <option value="USD">ุฏููุงุฑ ุฃูุฑููู (USD)</option>
                    </select>
                </div>
                <div class="form-group"> <label for="product-type">ุงููุฆุฉ:</label>
                    <select id="product-type" required>
                        <option value="ุงููุชุฑูููุงุช">ุฅููุชุฑูููุงุช</option>
                        <option value="ุฃุฒูุงุก ูููุงุจุณ">ุฃุฒูุงุก ูููุงุจุณ</option>
                        <option value="ุฃุฏูุงุช ููุฒููุฉ">ุฃุฏูุงุช ููุฒููุฉ</option>
                        <option value="ุฃุบุฐูุฉ ููุดุฑูุจุงุช">ุฃุบุฐูุฉ ููุดุฑูุจุงุช</option>
                        <option value="ุฎุฏูุงุช">ุฎุฏูุงุช</option>
                        <option value="ุฃุฎุฑู">ุฃุฎุฑู</option>
                    </select>
                </div>

                <div class="form-group full-width" style="border-top: 1px solid var(--light-hover-bg); padding-top: 15px;">
                    <label>ูุตุฏุฑ ุตูุฑุฉ ุงูููุชุฌ:</label>
                    <div class="image-mode-switch">
                        <button type="button" class="btn btn-primary" id="url-mode-btn" data-mode="url"><i class="fas fa-link"></i> ุฑุงุจุท ุฎุงุฑุฌู (URL)</button>
                        <button type="button" class="btn" id="file-mode-btn" data-mode="file"><i class="fas fa-upload"></i> ุชุญููู ูู ุงูุฌูุงุฒ</button>
                    </div>
                    <input type="url" id="product-image-url" placeholder="ุงูุตู ุฑุงุจุท ุงูุตูุฑุฉ ููุง (HTTPS://...)" required>
                    <input type="file" id="product-image-file" accept="image/*" style="display:none;">
                    <small id="image-help-text" style="color:#6c757d; font-size: 11px; margin-top: 5px; text-align: right;">(ููุงุญุธุฉ: ุฑูุน ุงูุตูุฑุฉ ูุจุงุดุฑุฉ ูุฒูุฏ ูู ุญุฌู ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ุงููุชุตูุญ)</small>
                </div>
                
                <div class="form-group full-width"> 
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <label for="product-description" style="margin-bottom: 0;">ูููุงุช ููุชุงุญูุฉ ููุจุญุซ:</label> 
                        </div>
                    <small style="color:#6c757d; font-size: 11px; margin-top: 5px; text-align: right;">(ูุชู ุงุณุชุฎุฏุงู ูุฐู ุงููููุงุช ูู ุงูุจุญุซ. ูุชู ุชูููุฏูุง ุชููุงุฆูุงู ุนูุฏ ุชุบููุฑ ุงูุงุณู ุฃู ุงููุฆุฉ ุฃู ุงูุณุนุฑ.)</small>
                    <textarea id="product-description" placeholder="ูุงุชู ุฐููุ ุณูุงุนุฉ ุจููุชูุซุ ุฃุณูุฏุ 256 ุฌูุฌุง..."></textarea> 
                </div>
                <div class="form-group full-width" style="margin-top: 10px;">
                    <button type="submit" class="btn btn-primary" id="save-button"><i class="fas fa-save"></i> ุญูุธ ุงูููุชุฌ ุงูุฌุฏูุฏ</button>
                    <button type="button" class="btn btn-danger" id="cancel-edit-button" style="display:none; margin-right: 10px;"><i class="fas fa-times"></i> ุฅูุบุงุก ุงูุชุนุฏูู</button>
                </div>
            </form>

            <h2>ุงูููุชุฌุงุช ุงูุญุงููุฉ ุงููุญููุธุฉ</h2>
            
            <div class="form-group full-width" style="margin-bottom: 20px; border: 1px dashed var(--light-hover-bg); padding: 15px; border-radius: 8px;">
                <label style="font-size: var(--font-md); color: var(--light-primary); margin-bottom: 10px;"><i class="fas fa-database"></i> ุฅุฏุงุฑุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ููููุชุฌุงุช:</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-success" onclick="requestPin('download')" style="flex-grow: 1;"><i class="fas fa-cloud-download-alt"></i> ุชูุฒูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุฏููุงู (JSON)</button>
                    
                    <button type="button" class="btn btn-info" onclick="requestPin('restore')" style="flex-grow: 1;"><i class="fas fa-cloud-upload-alt"></i> ุงุณุชุนุงุฏุฉ ูู ููู (JSON)</button>
                    
                    <input type="file" id="backup-file-input" accept=".json" style="display: none;" onchange="handleRestoreFile(event)">
                </div>
            </div>
            <div class="form-group full-width" style="margin-bottom: 20px;">
                <label for="product-search"><i class="fas fa-search"></i> ุงุจุญุซ ุนู ููุชุฌ (20 ุญุฑู ูุญุฏ ุฃูุตู):</label>
                <input type="text" id="product-search" placeholder="ุฃุฏุฎู ุงุณู ุงูููุชุฌ ุฃู ุฌุฒุกุงู ููู ููุจุญุซ..." maxlength="20">
            </div>
            <div id="product-list">
                </div>
        </div>
    </div>
    
    <div id="inactivity-warning" style="display: none;">
        <div>
            <i class="fas fa-clock" style="font-size: 40px; color: var(--light-danger); margin-bottom: 15px;"></i>
            <h3 style="color: var(--light-danger); margin-bottom: 10px;">ุชุญุฐูุฑ: ูุดู ุงูุชูุงุก ุงูุฌูุณุฉ!</h3>
            <p id="countdown-message" style="color: var(--light-text); font-size: 18px; font-weight: bold;">ุณูุชู ุฅุบูุงู ุงููููุน ุฎูุงู 60 ุซุงููุฉ.</p>
            <p style="color: #6c757d; font-size: 14px; margin-top: 15px;">ุงูุฑุฌุงุก ุชุญุฑูู ูุคุดุฑ ุงููุฃุฑุฉ ุฃู ุงูุถุบุท ุนูู ุฃู ููุชุงุญ ููุงุณุชูุฑุงุฑ.</p>
        </div>
    </div>


    <script>
        // =======================================================
        //                 ุงูุฅุนุฏุงุฏุงุช ุงูุณุฑูุฉ
        // =======================================================
        const ENCRYPTION_KEY = "YourSecretKey-12345"; 
        const ADMIN_PIN = "123456"; // ๐ ุฑูุฒ ุงูุชุฃููุฏ (PIN) ุงูุงูุชุฑุงุถู
        
        // ุฅุนุฏุงุฏุงุช ูุคูุช ุงูุฌูุณุฉ: 5 ุฏูุงุฆู ุฅุฌูุงููุฉ
        const TOTAL_SESSION_TIME_MS = 5 * 60 * 1000; // 5 ุฏูุงุฆู 
        const WARNING_TIME_MS = 60 * 1000;          // ุชุญุฐูุฑ ูุจู 60 ุซุงููุฉ ูู ุงูููุงูุฉ
        const INACTIVITY_LIMIT_MS = TOTAL_SESSION_TIME_MS - WARNING_TIME_MS; // 4 ุฏูุงุฆู ูุจู ุธููุฑ ุงูุชุญุฐูุฑ

        // ูุชุบูุฑ ูุคูุช ูุชุฎุฒูู ุงูุฅุฌุฑุงุก ุงููุทููุจ ุจุนุฏ ุฅุฏุฎุงู ุงูู PIN
        let pendingActionData = null; // ๐ ูุชุบูุฑ ุนุงููู ูุชุฎุฒูู ุจูุงูุงุช ุงูุฅุฌุฑุงุก ุงููุนูู (ูุซู ุจูุงูุงุช ุงูููุชุฌ ุฃู ูุนุฑู ุงูุญุฐู)
        
        // =======================================================
        //                   ูุธููุฉ ุนุฑุถ ุงูุฅุดุนุงุฑุงุช ุงูููุณูุฉ (ุจุฏูู ูู alert)
        // =======================================================
        
        // ๐ ูุชุบูุฑ ุนุงููู ููุชุงุจุนุฉ ุงูุฅุดุนุงุฑ ุงูุญุงูู
        let currentNotificationItem = null; 

        function showNotification(message, type = 'info', duration = 4000) {
            const container = document.getElementById('notification-container');
            
            // ๐ 1. ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑ ุงูุญุงูู ุฅุฐุง ูุงู ููุฌูุฏุงู
            if (currentNotificationItem) {
                // ุฅุฌุจุงุฑ ุงูุฅุดุนุงุฑ ุงูุญุงูู ุนูู ุงูุงุฎุชูุงุก ุงูููุฑู ูุฅุฒุงูุชู
                currentNotificationItem.classList.remove('show');
                clearTimeout(currentNotificationItem.timer);
                currentNotificationItem.remove(); 
                currentNotificationItem = null;
            }

            const item = document.createElement('div');
            
            let icon = '';
            let className = '';

            switch (type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    className = 'notification-success';
                    break;
                case 'error':
                    icon = 'fas fa-times-circle';
                    className = 'notification-error';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    className = 'notification-warning';
                    break;
                case 'info':
                default:
                    icon = 'fas fa-info-circle';
                    className = 'notification-info'; 
                    break;
            }

            item.className = `notification-item ${className}`;
            item.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
            
            container.appendChild(item);
            currentNotificationItem = item; // ๐ ุชุนููู ุงูุฅุดุนุงุฑ ุงูุฌุฏูุฏ ูุฅุดุนุงุฑ ุญุงูู

            setTimeout(() => { item.classList.add('show'); }, 10);
            
            // ๐ ุฅุถุงูุฉ ูุณุชูุน ูุฅุฎูุงุก ุงูุฅุดุนุงุฑ ุนูุฏ ุงูุถุบุท ุนููู
            item.addEventListener('click', () => {
                item.classList.remove('show');
                clearTimeout(item.timer);
                // ุงูุชุฃูุฏ ูู ุฃู ูุฐุง ุงูุฅุดุนุงุฑ ูู ุงูุฅุดุนุงุฑ ุงูุญุงูู ูุจู ุฅุฒุงูุชู ูุชุนููู null
                if (currentNotificationItem === item) {
                    item.remove();
                    currentNotificationItem = null;
                }
            });

            // ูุคูุช ุงูุฅุฎูุงุก ุงูุชููุงุฆู
            item.timer = setTimeout(() => {
                item.classList.remove('show');
                item.addEventListener('transitionend', () => {
                    // ๐ ุงูุชุฃูุฏ ูู ุฃู ูุฐุง ุงูุฅุดุนุงุฑ ูู ุงูุฅุดุนุงุฑ ุงูุญุงูู ูุจู ุฅุฒุงูุชู ูุชุนููู null
                    if (currentNotificationItem === item) {
                        item.remove();
                        currentNotificationItem = null;
                    }
                });
            }, duration);
        }
        
        // ๐ ุฏุงูุฉ ุนุฑุถ ุดุงุดุฉ ุชุฃููุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
        function showBackupPrompt(isDelete = false) {
            const modal = document.getElementById('backup-prompt-modal');
            const message = document.getElementById('prompt-message');
            
            if (!modal) return;
            
            if (isDelete) {
                message.innerHTML = 'ุชู ุญุฐู ุงูููุชุฌ ูู ุงููุชุตูุญ ุจูุฌุงุญ. ูู ุชุฑูุฏ ุชูุฒูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฌุฏูุฏุฉ ุงูุขู ูุชูุซูู ูุฐุง ุงูุญุฐูุ';
            } else {
                message.innerHTML = 'ุชู ุญูุธ ุงูุชุบููุฑุงุช ูู ุงููุชุตูุญ ุจูุฌุงุญ. ูู ุชุฑูุฏ ุชูุฒูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฌุฏูุฏุฉ ุงูุขู ูุญูุธ ุงูุชุบููุฑุงุช ูู ููู ุฎุงุฑุฌูุ';
            }

            modal.style.display = 'flex';
            
            // ุฅุนุฏุงุฏ ุงูุฃุฒุฑุงุฑ
            document.getElementById('confirm-backup-prompt-yes').onclick = () => finalizeBackupPrompt(true);
            document.getElementById('confirm-backup-prompt-no').onclick = () => finalizeBackupPrompt(false);
        }

        function finalizeBackupPrompt(shouldBackup) {
            const modal = document.getElementById('backup-prompt-modal');
            if (modal) modal.style.display = 'none';

            if (shouldBackup) {
                downloadBackupFile();
            } else {
                // ๐ ุชู ุญุฐู ุฅุดุนุงุฑ ุงูุฅูุบุงุก ููุง ุทูุจ ุงููุณุชุฎุฏู
            }
        }


        // =======================================================
        //                   ูุธุงุฆู ุฑูุฒ ุงูุชุฃููุฏ (PIN) - ูุญุตูุฑ ุจุงูุชูุฒูู/ุงูุงุณุชุนุงุฏุฉ/ุงูุชุนุฏูู/ุงูุญุฐู
        // =======================================================
        
        /**
         * ุทูุจ ุฑูุฒ ุงูุชุฃููุฏ
         * @param {string} actionType - ููุน ุงูุฅุฌุฑุงุก (download, restore, edit, delete)
         * @param {any} actionData - ุจูุงูุงุช ุงูุฅุฌุฑุงุก (ูุซู ุจูุงูุงุช ุงูููุชุฌ ุฃู ูุนุฑู ุงูุญุฐู)
         */
        window.requestPin = function(actionType, actionData = null) {
            // ๐ ุญูุธ ููุน ุงูุฅุฌุฑุงุก ูุจูุงูุงุชู
            pendingActionData = { type: actionType, data: actionData };
            
            const pinModal = document.getElementById('pin-modal');
            const pinInput = document.getElementById('pin-input');
            const pinSubmitBtn = document.getElementById('pin-submit-btn');

            if (pinModal) pinModal.style.display = 'flex';
            if (pinInput) {
                pinInput.value = '';
                pinInput.focus();
                
                if(actionType === 'delete') {
                    document.getElementById('pin-message').textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูุฒ ุชุฃููุฏ ุงูุฅุฏุงุฑุฉ ูุญุฐู ุงูููุชุฌ.';
                } else if(actionType === 'edit') {
                    document.getElementById('pin-message').textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูุฒ ุชุฃููุฏ ุงูุฅุฏุงุฑุฉ ูุญูุธ ุงูุชุนุฏููุงุช.';
                } else {
                     document.getElementById('pin-message').textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูุฒ ุชุฃููุฏ ุงูุฅุฏุงุฑุฉ ูููุชุงุจุนุฉ.';
                }
            }

            // ุฅุฒุงูุฉ ุงููุณุชูุนูู ุงููุฏุงูู ูุชุนููู ูุณุชูุน ุฌุฏูุฏ ูุชุฌูุจ ุงูุชูุฑุงุฑ
            pinSubmitBtn.onclick = null; 
            pinSubmitBtn.onclick = handlePinSubmission;
            
            // ุชูุนูู ุงูุฅุฑุณุงู ุจุงูุถุบุท ุนูู Enter
            pinInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    handlePinSubmission();
                }
            };
        }

        function handlePinSubmission() {
            const pinInput = document.getElementById('pin-input');
            const enteredPin = pinInput.value.trim();
            const pinModal = document.getElementById('pin-modal');

            if (enteredPin === ADMIN_PIN) {
                if (pinModal) pinModal.style.display = 'none';
                
                const actionType = pendingActionData ? pendingActionData.type : null;
                const data = pendingActionData ? pendingActionData.data : null; // ุจูุงูุงุช ุงูููุชุฌ ุฃู ID

                // ุชูููุฐ ุงูุฅุฌุฑุงุก ุงููุนูู ุจูุงุกู ุนูู ุงูููุน
                if (actionType === 'download') {
                    downloadBackupFile();
                } else if (actionType === 'restore') {
                    document.getElementById('backup-file-input').click();
                } else if (actionType === 'edit') { // ๐ ุชุนุฏูู ููุชุฌ
                    if (data) {
                        performSave(data); // data is the complete productData
                        showNotification('โ ุชู ุญูุธ ุงูุชุนุฏููุงุช ุจุนุฏ ุงูุชุญูู ูู ุฑูุฒ ุงูุชุฃููุฏ.', 'success', 4000);
                    } else {
                        showNotification('โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุงูููุชุฌ ููุชุนุฏูู.', 'error', 4000);
                    }
                } else if (actionType === 'delete') { // ๐ ุญุฐู ููุชุฌ
                    if (data) {
                        // ๐ ุงุณุชุจุฏุงู ุงูุญุฐู ุงููุจุงุดุฑ ุจุทูุจ ุงูุชุฃููุฏ ุงูุฌููู
                        showDeleteConfirmation(data); 
                    } else {
                        showNotification('โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ูุนุฑู ุงูููุชุฌ ููุญุฐู.', 'error', 4000);
                    }
                }
                
                pendingActionData = null; // ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช
            } else {
                showNotification('โ ุฑูุฒ ุงูุชุฃููุฏ ุบูุฑ ุตุญูุญ.', 'error', 3000);
                pinInput.value = '';
                pinInput.focus();
            }
        }
        
        // ๐ ุฏุงูุฉ ุนุฑุถ ุดุงุดุฉ ุชุฃููุฏ ุงูุญุฐู ุงูุฌูููุฉ ุจุนุฏ ุฅุฏุฎุงู ุงูู PIN
        function showDeleteConfirmation(productId) {
            const product = getProductById(productId);
            const modal = document.getElementById('delete-confirmation-modal');
            const productNameElement = document.getElementById('product-name-to-delete');
            
            if (!modal || !product) {
                showNotification('ุฎุทุฃ: ูุง ูููู ุนุฑุถ ุชุฃููุฏ ุงูุญุฐู. ุงูููุชุฌ ุบูุฑ ููุฌูุฏ.', 'error', 4000);
                return;
            }

            productNameElement.textContent = product.name;
            modal.style.display = 'flex';
            
            // ุฅุนุฏุงุฏ ุงูุฃุฒุฑุงุฑ ูุชูููุฐ ุงูุฅุฌุฑุงุก ุงูููุงุฆู ุฃู ุงูุฅูุบุงุก
            document.getElementById('confirm-delete-yes').onclick = () => {
                modal.style.display = 'none';
                performDeletion(productId); // ุงูุงูุชูุงู ููุญุฐู ุงููุนูู
            };
            
            document.getElementById('confirm-delete-no').onclick = () => {
                modal.style.display = 'none';
                showNotification('ุชู ุฅูุบุงุก ุนูููุฉ ุงูุญุฐู.', 'info', 3000);
            };
        }


        // =======================================================
        //                   ูุธุงุฆู ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ
        // =======================================================

        /**
         * ูุธููุฉ ุฅูุดุงุก ูุชูุฒูู ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ (JSON) ุงููุดูุฑ
         */
        window.downloadBackupFile = function() {
            const productsData = localStorage.getItem('productsEncrypted');
            if (!productsData || productsData === '[]') {
                showNotification('ูุง ุชูุฌุฏ ููุชุฌุงุช ุญุงููุงู ูุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ.', 'warning');
                return false; // ูุดู ุงูุชูุฒูู
            }
            
            const productsArray = JSON.parse(productsData);

            // 1. ุชุญููู ุงูุจูุงูุงุช (ุงููุดูุฑุฉ) ุฅูู ูุต JSON ูุน ุชูุณูู ุฌููู
            const productsJson = JSON.stringify(productsArray, null, 2); 
            
            // 2. ุฅูุดุงุก ูุงุฆู Blob ูู ุงููุต
            const blob = new Blob([productsJson], { type: 'application/json' });
            
            // 3. ุฅูุดุงุก ุฑุงุจุท ุชูุฒูู ูุฅุฌุฑุงุก ุงูููุฑ ุงูุชููุงุฆู
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // ุชุญุฏูุฏ ุงุณู ุงูููู ุจุทุงุจุน ุฒููู
            const date = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            a.download = `products_backup_${date}.json`;
            a.href = url;
            
            // ๐ ุชุญุณูู ุฅุดุนุงุฑ ุงูุชูุฒูู
            let downloadSuccess = false;
            a.addEventListener('click', () => {
                downloadSuccess = true;
            });

            document.body.appendChild(a);
            a.click();
            
            // ุชูุธูู ุงูุนูุงุตุฑ ุจุนุฏ ุงูุชูุฒูู
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // ุฅุธูุงุฑ ุงูุฅุดุนุงุฑ ุจูุงุกู ุนูู ูุญุงููุฉ ุงูุชูุฒูู
            setTimeout(() => {
                if (downloadSuccess) {
                    showNotification(`โ ุชู ุชูุฒูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ${productsArray.length} ููุชุฌ ูุดูุฑ.`, 'success', 5000);
                } else {
                    showNotification('โ ูุดู ุชูุฒูู ุงูููู ุชููุงุฆูุงู. ูุฑุฌู ุชุฌุฑุจุฉ ูุชุตูุญ ุขุฎุฑ ุฃู ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช.', 'error', 7000);
                }
            }, 100);
            
            return true; // ูุฌุงุญ ูุญุงููุฉ ุงูุชูุฒูู
        }

        /**
         * ูุธููุฉ ูุนุงูุฌุฉ ููู ุงูุงุณุชุนุงุฏุฉ ุงููุฑููุน (ุฏูุฌ ุงูููุชุฌุงุช ูุชุฌูุจ ุงูุชูุฑุงุฑ)
         */
        window.handleRestoreFile = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/json') {
                showNotification('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู ุจุตูุบุฉ JSON ุตุญูุญ.', 'error');
                event.target.value = ''; // Reset input
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const productsToRestore = JSON.parse(content);
                    const currentProductsRaw = loadProductsRaw();

                    if (!Array.isArray(productsToRestore) || productsToRestore.some(p => !p.id || !p.data)) {
                         showNotification('ูุญุชูู ุงูููู ุบูุฑ ุตุงูุญ. ูุฌุจ ุฃู ูุญุชูู ุนูู ูุตูููุฉ ุจูุงูุงุช ููุชุฌุงุช ูุดูุฑุฉ ุณูููุฉ.', 'error', 6000);
                         return;
                    }

                    // ๐ ุฏูุฌ ุงูููุชุฌุงุช: ูุชู ุฏูุฌ ุงูููุชุฌุงุช ุงููุณุชุนุงุฏุฉ ูุน ุงูููุชุฌุงุช ุงูุญุงููุฉ.
                    let addedCount = 0;
                    let updatedCount = 0;
                    
                    productsToRestore.forEach(restoredProduct => {
                        const index = currentProductsRaw.findIndex(p => p.id === restoredProduct.id);
                        if (index !== -1) {
                            // ุงูููุชุฌ ููุฌูุฏุ ูุชู ุชุญุฏูุซู
                            currentProductsRaw[index].data = restoredProduct.data;
                            updatedCount++;
                        } else {
                            // ุงูููุชุฌ ุบูุฑ ููุฌูุฏุ ูุชู ุฅุถุงูุชู
                            currentProductsRaw.push(restoredProduct);
                            addedCount++;
                        }
                    });

                    // ุญูุธ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ุงููุฏูุฌุฉ
                    localStorage.setItem('productsEncrypted', JSON.stringify(currentProductsRaw));
                    
                    showNotification(`โ ุชู ุฏูุฌ ุงูููุชุฌุงุช ุจูุฌุงุญ. ุฃุถูู: ${addedCount}ุ ุญุฏุซ: ${updatedCount}. ุฅุฌูุงูู ุงูููุชุฌุงุช: ${currentProductsRaw.length}.`, 'success', 8000);
                    
                    // ุฅุนุงุฏุฉ ุฑุณู ูุงุฆูุฉ ุงูููุชุฌุงุช ุจุนุฏ ุงูุงุณุชุนุงุฏุฉ
                    renderProductList(document.getElementById('product-search').value);
                    
                    // ุทูุจ ุชุฃููุฏ ุชุญุฏูุซ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ (ููุชูุฒูู ุงููุฏูู)
                    if (productsToRestore.length > currentProductsRaw.length - addedCount) {
                        showBackupConfirmation(currentProductsRaw.length, productsToRestore.length, addedCount, updatedCount);
                    }


                } catch (error) {
                    showNotification('โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุฃู ุชุญููู ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ. ุชุฃูุฏ ุฃูู ููู JSON ุณููู.', 'error', 6000);
                    console.error('Restore Error:', error);
                } finally {
                    // ุฅูุฑุงุบ ูููุฉ ุงููุฏุฎู ููุณูุงุญ ุจุงุฎุชูุงุฑ ููุณ ุงูููู ูุฑุฉ ุฃุฎุฑู
                    event.target.value = ''; 
                }
            };
            
            reader.onerror = function() {
                showNotification('โ ุชุนุฐุฑ ูุฑุงุกุฉ ุงูููู.', 'error');
            };

            reader.readAsText(file);
        }
        
        // ุดุงุดุฉ ุชุฃููุฏ ุชุญุฏูุซ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ (ุนูุฏ ุงูุงุณุชุนุงุฏุฉ)
        let countdownBackupTimer;

        function showBackupConfirmation(newTotalCount, restoredCount, addedCount, updatedCount) {
            const modal = document.getElementById('backup-confirmation-modal');
            const message = document.getElementById('confirmation-message');
            const countdownMsg = document.getElementById('countdown-backup-message');
            const btnYes = document.getElementById('confirm-backup-yes');
            const btnNo = document.getElementById('confirm-backup-no');
            
            if (!modal) return;
            
            message.innerHTML = `ุชู ุงุณุชุนุงุฏุฉ ${restoredCount} ููุชุฌ (ุฃุถูู: ${addedCount}ุ ุญุฏุซ: ${updatedCount}). ูู ุชุฑูุฏ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฌุฏูุฏุฉ ููุฐุง ุงูุฏูุฌ ูู ุงููุชุตูุญ (${newTotalCount} ููุชุฌ)ุ ุณูุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ **ุชููุงุฆูุงู** ุจุนุฏ 10 ุซูุงูู.`;
            modal.style.display = 'flex';

            let timeLeft = 10;
            
            // ุฅููุงู ุฃู ูุคูุช ุณุงุจู
            if (countdownBackupTimer) clearTimeout(countdownBackupTimer);

            function updateCountdown() {
                countdownMsg.textContent = `ุงูุชูููุฐ ุงูุชููุงุฆู ุฎูุงู: ${timeLeft} ุซูุงูู...`;
                if (timeLeft <= 0) {
                    finalizeBackupConfirmation(true); // ูุนูุ ุชุญุฏูุซ ุชููุงุฆู
                } else {
                    timeLeft--;
                    countdownBackupTimer = setTimeout(updateCountdown, 1000);
                }
            }
            
            updateCountdown();
            
            // ุฅุนุฏุงุฏ ุฃุฒุฑุงุฑ ุงูุชุฃููุฏ
            btnYes.onclick = () => finalizeBackupConfirmation(true);
            btnNo.onclick = () => finalizeBackupConfirmation(false);
        }

        function finalizeBackupConfirmation(shouldBackup) {
            const modal = document.getElementById('backup-confirmation-modal');
            clearTimeout(countdownBackupTimer);
            if (modal) modal.style.display = 'none';

            if (shouldBackup) {
                // ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุฏุงูุฉ ุงูุชูุฒูู ูุชุญููุฒ ุงููุณุชุฎุฏู ุนูู ุญูุธ ุงููุณุฎุฉ ุงููุฏููุฌุฉ
                downloadBackupFile();
            } else {
                showNotification('ุชู ุฅูุบุงุก ุชุญุฏูุซ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูู ููู (JSON).', 'info', 3000);
            }
        }


        // =======================================================
        //                   ูุคูุช ุงูุฎุฑูุฌ ุงูุชููุงุฆู ุงูุฃููู
        // =======================================================
        let inactivityTimer; 
        let countdownTimer;  

        // ูุฐู ุงูุฏุงูุฉ ุชุนูุฏ ุงููุคูุช ูุตูุฑ ุนูุฏ ุฃู ูุดุงุท
        function resetTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(countdownTimer);
            
            const warningDiv = document.getElementById('inactivity-warning');
            if(warningDiv) warningDiv.style.display = 'none'; 
            
            startInactivityTimer();
        }

        // ูุฐู ุงูุฏุงูุฉ ุชุจุฏุฃ ุงููุคูุช ุงูุฐู ูุคุฏู ูุธููุฑ ุดุงุดุฉ ุงูุชุญุฐูุฑ
        function startInactivityTimer() {
            if(sessionStorage.getItem('isAuthenticated') === 'true') {
                 inactivityTimer = setTimeout(showWarning, INACTIVITY_LIMIT_MS);
            }
        }

        // ูุฐู ุงูุฏุงูุฉ ุชุธูุฑ ุดุงุดุฉ ุงูุชุญุฐูุฑ ูุชุจุฏุฃ ุงูุนุฏ ุงูุชูุงุฒูู ููุฎุฑูุฌ
        function showWarning() {
            const warningDiv = document.getElementById('inactivity-warning');
            const countdownMsg = document.getElementById('countdown-message');
            if(warningDiv) warningDiv.style.display = 'flex';
            
            let timeLeft = WARNING_TIME_MS / 1000; 

            function updateCountdown() {
                // ุงูุชุฃูุฏ ูู ุฃู ุงูุฌูุณุฉ ูุง ุฒุงูุช ูุงุฆูุฉ ูุจู ุงุณุชููุงู ุงูุนุฏ
                if (sessionStorage.getItem('isAuthenticated') !== 'true') {
                    clearTimeout(countdownTimer);
                    if(warningDiv) warningDiv.style.display = 'none';
                    return;
                }
                
                if(countdownMsg) countdownMsg.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ุณูุชู ุฅุบูุงู ุงููููุน ุฎูุงู <strong>${timeLeft} ุซุงููุฉ</strong>.`;

                if (timeLeft <= 0) {
                    clearTimeout(countdownTimer);
                    showNotification('ุงูุชูุช ูุฏุฉ ุงูุฌูุณุฉ ุงูุฃูููุฉ. ุณูุชู ุชุณุฌูู ุงูุฎุฑูุฌ.', 'error'); 
                    sessionTimeoutLogout(); // ุชูููุฐ ุงูุฎุฑูุฌ ุงูุชููุงุฆู
                } else {
                    timeLeft--;
                    countdownTimer = setTimeout(updateCountdown, 1000);
                }
            }
            
            updateCountdown();
        }
        
        // ุฏุงูุฉ ุงูุฎุฑูุฌ ุงูุชููุงุฆู ุนูุฏ ุงูุชูุงุก ุงูุฌูุณุฉ
        function sessionTimeoutLogout() {
            sessionStorage.removeItem('isAuthenticated');
            sessionStorage.removeItem('adminUser');
            clearTimeout(inactivityTimer);
            clearTimeout(countdownTimer);
            
            // ุชุญููู ุงููุณุชุฎุฏู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู ุจุนุฏ ุธููุฑ ุฑุณุงูุฉ ุงูุฎุทุฃ
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500); 
        }


        // ุชูุนูู ุชุชุจุน ุงููุดุงุท
        function setupInactivityTracking() {
            const events = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
            events.forEach(event => {
                document.addEventListener(event, resetTimer);
            });
            startInactivityTimer();
        }


        // =======================================================
        //                   ูุธุงุฆู ุงูุชุดููุฑ ููู ุงูุชุดููุฑ
        // =======================================================
        function encryptData(data) {
            let unencoded = unescape(encodeURIComponent(data));
            let result = '';
            for (let i = 0; i < unencoded.length; i++) {
                result += String.fromCharCode(unencoded.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length));
            }
            return btoa(result);
        }

        function decryptData(hash) {
            try {
                let decoded = atob(hash);
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    result += String.fromCharCode(decoded.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length));
                }
                return decodeURIComponent(escape(result));
            } catch (e) {
                return JSON.stringify({});
            }
        }
        
        // =======================================================
        //                   ูุธุงุฆู ุงูุชุญูู ูู ุงูุฏุฎูู (ุงุณุชุฎุฏุงู sessionStorage)
        // =======================================================
        function checkAuthentication() {
            // ุงูุชุญูู ูู ุงูุฌูุณุฉ ูู sessionStorage
            const isAuthenticated = sessionStorage.getItem('isAuthenticated') === 'true'; 
            const adminContent = document.getElementById('admin-content');
            const authMessage = document.getElementById('auth-message');

            if (!isAuthenticated) {
                // ุชุทุจูู ูุถุน ุงูููู ูู ุญุงู ุนุฏู ุชุณุฌูู ุงูุฏุฎูู
                adminContent.classList.add('is-locked');
                authMessage.innerHTML = `<p style="color: var(--light-danger); font-size: 18px;"><i class="fas fa-exclamation-triangle"></i> ุงูุชูุช ุงูุฌูุณุฉ. ุณูุชู ุชุญูููู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู.</p>`;
                
                // ุชุญููู ุงููุณุชุฎุฏู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู ุจุนุฏ ุธููุฑ ุฑุณุงูุฉ ุงูุฎุทุฃ
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            } else {
                authMessage.style.display = 'none';
                adminContent.classList.remove('hidden-content');
                adminContent.classList.remove('is-locked'); // ุฅุฒุงูุฉ ุงูููู ุนูุฏ ุงููุฌุงุญ
                initializePage();
            }
        }

        // ๐ ุฏุงูุฉ ุงูุฎุฑูุฌ ุงูุฑุฆูุณูุฉ
        function logout() {
            showLogoutConfirmation();
        }
        window.logout = logout;

        // ๐ ุฏุงูุฉ ุนุฑุถ ุดุงุดุฉ ุชุฃููุฏ ุชุณุฌูู ุงูุฎุฑูุฌ ุงููุจุณุทุฉ
        function showLogoutConfirmation() {
            const modal = document.getElementById('logout-confirmation-modal');
            const confirmBtn = document.getElementById('confirm-logout-direct');
            const cancelBtn = document.getElementById('confirm-logout-cancel');

            if (!modal) {
                if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌุ')) {
                    performLogout();
                }
                return;
            }
            
            // ุชููุฆุฉ ุงูุฃุฒุฑุงุฑ (ูุชู ุชุญุฏูุซูุง ุชููุงุฆูุงู ุจุนุฏ ุชุบููุฑ innerHTML)
            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                performLogout(); 
            };

            cancelBtn.onclick = () => {
                modal.style.display = 'none';
            };

            modal.style.display = 'flex';
        }

        // ุงููุธููุฉ ุงูุฃุณุงุณูุฉ ูุชูููุฐ ุชุณุฌูู ุงูุฎุฑูุฌ ุจุนุฏ ุงูุชุฃููุฏ ุฃู ุงูุชูุฒูู
        function performLogout() {
            // ุฅุฒุงูุฉ ุงูุฌูุณุฉ ูู sessionStorage
            sessionStorage.removeItem('isAuthenticated'); 
            sessionStorage.removeItem('adminUser'); 
            
            // ุฅููุงู ุงููุคูุชุงุช ุงูุฃูููุฉ
            clearTimeout(inactivityTimer);
            clearTimeout(countdownTimer);
            
            window.location.href = 'login.html';
        }

        // =======================================================
        //                   ูุธุงุฆู ุงูุชุนุงูู ูุน ุงูุตูุฑ (ุฑูุน ูู ุงูุฌูุงุฒ)
        // =======================================================
        
        // ุชุญููู ููู ุงูุตูุฑุฉ ุฅูู Base64
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function setupImageModeSwitch() {
            const urlBtn = document.getElementById('url-mode-btn');
            const fileBtn = document.getElementById('file-mode-btn');
            const urlInput = document.getElementById('product-image-url');
            const fileInput = document.getElementById('product-image-file');

            const switchMode = (mode) => {
                const helpTextElement = document.getElementById('image-help-text');
                if (mode === 'url') {
                    urlInput.style.display = 'block';
                    urlInput.required = true;
                    fileInput.style.display = 'none';
                    fileInput.required = false;
                    urlBtn.classList.add('btn-primary');
                    fileBtn.classList.remove('btn-primary');
                    fileInput.value = ''; 
                    if(helpTextElement) helpTextElement.textContent = '(ููุงุญุธุฉ: ุฑูุน ุงูุตูุฑุฉ ูุจุงุดุฑุฉ ูุฒูุฏ ูู ุญุฌู ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ุงููุชุตูุญ)'; 
                } else {
                    urlInput.style.display = 'none';
                    urlInput.required = false;
                    fileInput.style.display = 'block';
                    fileInput.required = true;
                    fileBtn.classList.add('btn-primary');
                    urlBtn.classList.remove('btn-primary');
                    urlInput.value = ''; 
                    if(helpTextElement) helpTextElement.textContent = '(ููุงุญุธุฉ: ุฑูุน ุงูุตูุฑุฉ ูุจุงุดุฑุฉ ูุฒูุฏ ูู ุญุฌู ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ุงููุชุตูุญ)'; 
                }
            };
            
            urlBtn.addEventListener('click', () => switchMode('url'));
            fileBtn.addEventListener('click', () => switchMode('file'));

            switchMode('url');
        }


        // =======================================================
        //                   ูุธุงุฆู ุงูุฅุฏุงุฑุฉ ุงูุฑุฆูุณูุฉ ูุงูุฎุตู
        // =======================================================

        /**
         * ุฏุงูุฉ ูุณุงุนุฏุฉ ูุญุณุงุจ ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู ูุชูุฑูุจู ูุฑูููู ุนุดุฑููู
         */
        function calculateDiscountedPrice(price, discount) {
            // ุงูุชุฃูุฏ ูู ุฃู ุงูุฎุตู ุถูู ุงููุทุงู ุงูุตุญูุญ
            if (discount <= 0 || discount > 100 || isNaN(discount)) return price; 
            const finalPrice = price * (1 - discount / 100);
            // ุชูุฑูุจ ุฅูู ุฎุงูุชูู ุนุดุฑูุชูู
            return Math.round(finalPrice * 100) / 100; 
        }

        function loadProductsRaw() {
            return JSON.parse(localStorage.getItem('productsEncrypted')) || []; // ุจูุงูุงุช ุงูููุชุฌุงุช ุชุจูู ูู localStorage
        }
        
        function getProductById(productId) {
            const productsEncrypted = loadProductsRaw();
            const rawItem = productsEncrypted.find(item => item.id === productId);
            if (rawItem) {
                const decryptedData = decryptData(rawItem.data);
                try {
                    return JSON.parse(decryptedData);
                } catch(e) {
                    console.error("Failed to parse decrypted data:", decryptedData);
                    return null;
                }
            }
            return null;
        }
        
        // ๐ ุฏุงูุฉ ุงูุญูุธ ุงููุนูู ููููุชุฌ ุจุนุฏ ุฌูุน ุงูุจูุงูุงุช (ุชูุณุชุฏุนู ูุจุงุดุฑุฉ ููุฅุถุงูุฉุ ูุนุจุฑ PIN ููุชุนุฏูู)
        async function performSave(product) {
            const productString = JSON.stringify(product);
            const encryptedData = encryptData(productString);

            let productsEncrypted = loadProductsRaw();
            
            const index = productsEncrypted.findIndex(item => item.id === product.id);

            if (index !== -1) {
                // ุชุนุฏูู ููุชุฌ ููุฌูุฏ
                productsEncrypted[index].data = encryptedData;
                showNotification(`โ ุชู ุชุนุฏูู ุงูููุชุฌ "${product.name}" ุจูุฌุงุญ!`, 'success'); 
            } else {
                // ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ
                productsEncrypted.push({ id: product.id, data: encryptedData });
                showNotification(`โ ุชู ุญูุธ ุงูููุชุฌ "${product.name}" ุจูุฌุงุญ!`, 'success'); 
            }
            
            localStorage.setItem('productsEncrypted', JSON.stringify(productsEncrypted));
            
            resetForm();
            // ุฅุนุงุฏุฉ ุนุฑุถ ุงููุงุฆูุฉ ูุน ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงูุญุงูู ุฅู ูุฌุฏ
            renderProductList(document.getElementById('product-search').value);
            
            // ๐ ุนุฑุถ ุดุงุดุฉ ุชุฃููุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจุฏูุงู ูู ุฑุณุงูุฉ ุงูุชุฐููุฑ
            showBackupPrompt(false); 
        }

        /**
         * ๐ ุฏุงูุฉ ุชูููุฏ ุงููููุงุช ุงูููุชุงุญูุฉ ุชููุงุฆูุงู ุจูุงุกู ุนูู ุงุณู ุงูููุชุฌ ูุงููุฆุฉ ูุงูุณุนุฑ
         */
        window.generateKeywordsFromFields = function() {
            const name = document.getElementById('product-name').value.trim();
            const type = document.getElementById('product-type').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);

            // 1. ุฌูุน ุงููููุงุช ุงูุฃุณุงุณูุฉ
            let newKeywords = [];
            
            // ุฅุถุงูุฉ ุงููููุงุช ูู ุงูุงุณู (ุชูุณูู ุจุงููุณุงูุฉ)
            name.split(/\s+/).forEach(word => {
                if (word.length > 1) newKeywords.push(word);
            });

            // ุฅุถุงูุฉ ุงููุฆุฉ
            if (type && type !== 'ุฃุฎุฑู') newKeywords.push(type);
            
            // ุฅุถุงูุฉ ุงูุณุนุฑ ููููุฉ ููุชุงุญูุฉ (ุฅุฐุง ูุงู ุฑูููุง ุตุญูุญูุง)
            if (!isNaN(price) && price > 0) {
                const integerPrice = Math.floor(price);
                // ูุถูู ุงูุณุนุฑ ุฅุฐุง ูุงู ูุง ููุฌุฏ ูู ุฃุตูุงุฑ ุนูู ุงููููู 
                if (price.toString().split('.')[0] !== '0') {
                    newKeywords.push(integerPrice.toString());
                }
            }


            // 2. ุชูููุฉ ุงููููุงุช ูุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
            const finalKeywords = newKeywords
                .map(k => k.toLowerCase().replace(/[^\u0600-\u06FFa-zA-Z0-9\s]/g, '').trim()) // ุฅุฒุงูุฉ ุนูุงูุงุช ุงูุชุฑููู ูุงูุฃุญุฑู ุบูุฑ ุงููุฑุบูุจุฉ
                .filter(k => k.length > 1) // ุฅุฒุงูุฉ ุงููููุงุช ุงููุตูุฑุฉ
                .filter((value, index, self) => self.indexOf(value) === index); // ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช

            // 3. ุชุญุฏูุซ ูุฑุจุน ุงููุต (ููุถู ุงููุตู ุจุงููุงุตูุฉ ูุงููุณุงูุฉ ูุณูููุฉ ุงููุฑุงุกุฉ)
            const newDescription = finalKeywords.join(', ');
            document.getElementById('product-description').value = newDescription;
        };

        // ๐ ุฏุงูุฉ saveProduct ุงูุฌุฏูุฏุฉ (ุชุฌูุน ุงูุจูุงูุงุช ูุชููุฐ ุงูุญูุธ ุฃู ุชุทูุจ PIN)
        async function saveProduct(event) {
            event.preventDefault();

            const productIdToEdit = document.getElementById('product-id-to-edit').value;
            const isEdit = !!productIdToEdit; // ๐ ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ุชุนุฏููุงู
            
            const name = document.getElementById('product-name').value.trim();
            const priceInput = document.getElementById('product-price');
            const price = parseFloat(priceInput.value);
            const currency = document.getElementById('product-currency').value;
            const type = document.getElementById('product-type').value;
            // ๐ ูุนุชูุฏ ุนูู ูุง ุฃุฏุฎูู ุงููุณุชุฎุฏู ุฃู ูุง ุชู ุชูููุฏู ูู ุงูุญูู ูุจุงุดุฑุฉ
            const description = document.getElementById('product-description').value.trim(); 
            
            // --- 1. Validation ---
            if (name.length < 2) {
                 showNotification('โ ุฎุทุฃ: ุงุณู ุงูููุชุฌ ูุตูุฑ ุฌุฏุงู.', 'error', 4000);
                 return;
            }

            if (isNaN(price) || price <= 0) {
                 showNotification('โ ุฎุทุฃ: ูุฌุจ ุฅุฏุฎุงู ุณุนุฑ ุฃุตูู ุตุญูุญ ุฃูุจุฑ ูู ุตูุฑ.', 'error', 4000);
                 return;
            }


            // ๐ Discount Logic - ุชุญุฏูุฏ ูููุฉ ุงูุฎุตู ุงูููุงุฆูุฉ
            const isPercentMode = document.getElementById('discount-mode-percent').classList.contains('btn-primary');
            const percentInput = document.getElementById('product-discount-percent');
            const priceInputDiscounted = document.getElementById('product-discount-price');
            
            let discountValue = 0;
            
            if (isPercentMode) {
                discountValue = parseFloat(percentInput.value) || 0;
            } else {
                const finalPriceInput = parseFloat(priceInputDiscounted.value);
                const originalPrice = price;

                if (finalPriceInput >= originalPrice) {
                    showNotification('โ ุฎุทุฃ: ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู ูุฌุจ ุฃู ูููู ุฃูู ูู ุงูุณุนุฑ ุงูุฃุตูู. ูุฑุฌู ุชุตุญูุญ ุงูุณุนุฑ.', 'error', 4000);
                    return;
                }
                
                const discountAmount = originalPrice - finalPriceInput;
                discountValue = (discountAmount / originalPrice) * 100;
            }
            
            if (discountValue < 0 || discountValue > 100) {
                 showNotification('โ ุฎุทุฃ: ูุฌุจ ุฃู ุชููู ูุณุจุฉ ุงูุฎุตู ุงููุญุณูุจุฉ ุจูู 0 ู 100.', 'error', 4000);
                 return;
            }


            // --- 2. Image Processing ---
            const urlInput = document.getElementById('product-image-url');
            const fileInput = document.getElementById('product-image-file');

            let imageSource = '';
            
            if (fileInput.files.length > 0 && fileInput.style.display !== 'none') {
                try {
                    imageSource = await readFileAsDataURL(fileInput.files[0]);
                    if (imageSource.length > (3 * 1024 * 1024)) { 
                        showNotification('ุชุญุฐูุฑ: ุญุฌู ุงูุตูุฑุฉ ุงูุชู ุชู ุฑูุนูุง ูุจูุฑ ุฌุฏุงู ููุฏ ูุคุฏู ุฅูู ุจุทุก ุงููุชุตูุญ. ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ ุฃุตุบุฑ ุฃู ุงุณุชุฎุฏุงู ุฑุงุจุท ุฎุงุฑุฌู.', 'warning', 6000);
                    }
                } catch (e) {
                    showNotification('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ููู ุงูุตูุฑุฉ. ุชุฃูุฏ ูู ุฃู ุงูููู ูู ุตูุฑุฉ ุตุงูุญุฉ.', 'error');
                    return;
                }
            } else if (urlInput.value.trim() && urlInput.style.display !== 'none') {
                imageSource = urlInput.value.trim();
            } else if (productIdToEdit) {
                const existingProduct = getProductById(productIdToEdit);
                imageSource = existingProduct ? existingProduct.image : '';
            }

            if (!imageSource) {
                showNotification('ุงูุฑุฌุงุก ุชุนุจุฆุฉ ุฌููุน ุงูุญููู ุงููุทููุจุฉ (ุจูุง ูู ุฐูู ุงูุตูุฑุฉ).', 'warning');
                return;
            }

            // --- 3. Final Product Data ---
            const productData = { 
                id: productIdToEdit || ('prod_' + Date.now()),
                name, 
                price: price, 
                discount: discountValue,
                currency, 
                type, 
                description, 
                image: imageSource
            };
            
            // --- 4. Decide on Save Method (Direct Save for Add, PIN for Edit) ---
            if (!isEdit) {
                // ๐ ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ: ุญูุธ ูุจุงุดุฑ
                performSave(productData); 
            } else {
                // ๐ ุชุนุฏูู ููุชุฌ ููุฌูุฏ: ุทูุจ ุฑูุฒ ุงูุชุฃููุฏ ุฃููุงู
                requestPin('edit', productData); // ููุฑุฑ ููุน ุงูุฅุฌุฑุงุก ูุจูุงูุงุช ุงูููุชุฌ
            }
        }

        function resetForm() {
            document.getElementById('product-form').reset();
            document.getElementById('product-id-to-edit').value = '';
            document.getElementById('save-button').innerHTML = '<i class="fas fa-save"></i> ุญูุธ ุงูููุชุฌ ุงูุฌุฏูุฏ';
            document.getElementById('page-title').textContent = 'ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ ๐';
            document.getElementById('cancel-edit-button').style.display = 'none';
            document.getElementById('product-discount-percent').value = '0'; // ๐ ุฅุนุงุฏุฉ ุงูุฎุตู ูููููุฉ ุงูุงูุชุฑุงุถูุฉ
            document.getElementById('product-discount-price').value = ''; 
            document.getElementById('discount-auto-calc-message').textContent = '';
            setupImageModeSwitch(); 
            setupDiscountSwitch('percent'); // ๐ ุฅุนุงุฏุฉ ุชููุฆุฉ ูุถุน ุงูุฎุตู ุงูุงูุชุฑุงุถู
        }
        document.getElementById('cancel-edit-button').addEventListener('click', resetForm);

        window.editProduct = function(productId) {
            const product = getProductById(productId);
            if (!product) {
                showNotification('ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุชุฌ ุงููุทููุจ ุชุนุฏููู.', 'error');
                return;
            }

            document.getElementById('product-id-to-edit').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            
            document.getElementById('product-discount-percent').value = product.discount || 0; 
            
            setupDiscountSwitch('percent'); 
            
            handleDiscountChange(document.getElementById('product-discount-percent'), 'percent', true);
            
            document.getElementById('product-currency').value = product.currency;
            document.getElementById('product-type').value = product.type;
            document.getElementById('product-description').value = product.description;

            const isBase64 = product.image && product.image.startsWith('data:');
            const helpTextElement = document.getElementById('image-help-text');
            const urlInput = document.getElementById('product-image-url');

            urlInput.value = product.image || ''; 
            document.getElementById('url-mode-btn').click(); 
            
            if (isBase64) {
                if(helpTextElement) helpTextElement.textContent = '(ููุงุญุธุฉ: ุชู ุชุญููู ุงูุตูุฑุฉ ูุณุจููุง ูููู ูุดูุฑ (Base64). ูุง ุชูู ุจุญุฐู ูุฐุง ุงููุต ุงูุทููู ุฅูุง ุฅุฐุง ููุช ุชุฑูุฏ ุงุณุชุจุฏุงู ุงูุตูุฑุฉ ุจุฑุงุจุท ุฃู ููู ุฌุฏูุฏ.)';
            } else {
                if(helpTextElement) helpTextElement.textContent = '(ููุงุญุธุฉ: ุฑูุน ุงูุตูุฑุฉ ูุจุงุดุฑุฉ ูุฒูุฏ ูู ุญุฌู ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ุงููุชุตูุญ)';
            }
            
            document.getElementById('page-title').textContent = `ุชุนุฏูู ุงูููุชุฌ: ${product.name}`;
            document.getElementById('save-button').innerHTML = '<i class="fas fa-pen"></i> ุญูุธ ุงูุชุนุฏููุงุช';
            document.getElementById('cancel-edit-button').style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ๐ ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชูููุฐ ุงูุญุฐู ุงููุนูู (ุชูุณุชุฏุนู ุจุนุฏ ุฅุฏุฎุงู PIN ููุงูุฐุฉ ุงูุชุฃููุฏ)
        function performDeletion(productId) {
            let productsEncrypted = loadProductsRaw();
            const updatedProducts = productsEncrypted.filter(item => item.id !== productId);
            
            // ุชุญูู ุฃููู ุฅุถุงูู: ููุชุฃูุฏ ูู ุฃู ุงูููุชุฌ ูุงู ููุฌูุฏุงู ูุนูุงู
            if (updatedProducts.length === productsEncrypted.length) {
                showNotification('โ ูุดู ุงูุญุฐู. ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุชุฌ.', 'error');
                return;
            }
            
            localStorage.setItem('productsEncrypted', JSON.stringify(updatedProducts));

            showNotification('โ ุชู ุญุฐู ุงูููุชุฌ ุจูุฌุงุญ.', 'success'); 
            
            // ุนุฑุถ ุดุงุดุฉ ุชุฃููุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจุนุฏ ุงูุญุฐู
            showBackupPrompt(true); 
            
            const searchInput = document.getElementById('product-search');
            renderProductList(searchInput ? searchInput.value : '');
        }

        window.deleteProduct = function(productId) {
            // ๐ ุงุณุชุจุฏุงู ุฑุณุงูุฉ ุงูุชุฃููุฏ ุจุทูุจ ุฑูุฒ ุงูุชุฃููุฏ
            requestPin('delete', productId);
        }
        
        // ๐ ุฏุงูุฉ ุฅุนุฏุงุฏ ููุชุงุญ ุงูุชุจุฏูู ุจูู ูุถุน ุงูุฎุตู
        function setupDiscountSwitch(initialMode = 'percent') {
            const percentBtn = document.getElementById('discount-mode-percent');
            const priceBtn = document.getElementById('discount-mode-price');
            const percentGroup = document.getElementById('discount-percent-group');
            const priceGroup = document.getElementById('discount-price-group');
            const percentInput = document.getElementById('product-discount-percent');
            const originalPriceInput = document.getElementById('product-price');
            
            const switchMode = (mode) => {
                if (mode === 'percent') {
                    percentBtn.classList.add('btn-primary');
                    priceBtn.classList.remove('btn-primary');
                    percentGroup.style.display = 'block';
                    priceGroup.style.display = 'none';
                    // ุนูุฏ ุงูุชุจุฏูู ุฅูู ุงููุณุจุฉุ ูุญุณุจ ุงููุณุจุฉ ูู ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู (ุฅู ูุฌุฏ) ููุญุฏุซ ุงููุณุจุฉ
                    handleDiscountChange(document.getElementById('product-discount-price'), 'price-after', true);
                } else {
                    priceBtn.classList.add('btn-primary');
                    percentBtn.classList.remove('btn-primary');
                    priceGroup.style.display = 'block';
                    percentGroup.style.display = 'none';
                    // ุนูุฏ ุงูุชุจุฏูู ุฅูู ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตูุ ูุญุณุจ ุงูุณุนุฑ ูู ุงููุณุจุฉ ููุญุฏุซ ุงูุณุนุฑ
                    handleDiscountChange(percentInput, 'percent', true);
                }
            };
            
            percentBtn.onclick = () => switchMode('percent');
            priceBtn.onclick = () => switchMode('price-after');
            
            // ุชุทุจูู ุงููุถุน ุงูุฃููู
            switchMode(initialMode);
            
            // ุฑุจุท ูุฏุฎู ุงูุณุนุฑ ุงูุฃุตูู ุจุงูุชุบููุฑุงุช
            originalPriceInput.oninput = () => {
                // ๐ ุฅุถุงูุฉ ุชูููุฏ ุงููููุงุช ุงูููุชุงุญูุฉ
                generateKeywordsFromFields();
                
                const isPercentMode = percentBtn.classList.contains('btn-primary');
                if (isPercentMode) {
                    handleDiscountChange(percentInput, 'percent', true);
                } else {
                    handleDiscountChange(document.getElementById('product-discount-price'), 'price-after', true);
                }
            };
        }
        
        // ๐ ุฏุงูุฉ ูุนุงูุฌุฉ ุชุบููุฑุงุช ุงูุฎุตู (ุงูุญุณุงุจ ูุงูุชุตุญูุญ ุงูุชููุงุฆู)
        window.handleDiscountChange = function(inputElement, mode, isSilent = false) {
            const originalPriceInput = document.getElementById('product-price');
            const originalPrice = parseFloat(originalPriceInput.value);
            const percentInput = document.getElementById('product-discount-percent');
            const priceInput = document.getElementById('product-discount-price');
            const messageElement = document.getElementById('discount-auto-calc-message');
            const currency = document.getElementById('product-currency').value;
            
            if (isNaN(originalPrice) || originalPrice <= 0) {
                if (!isSilent) showNotification('โ ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุณุนุฑ ุงูุฃุตูู ุฃููุงู.', 'warning', 3000);
                // ูุง ููุณุญ ุงููููุฉ ูู ูุถุน ุงูุฅุฏุฎุงู ุงูุตุงูุช ุญุชู ูุง ูููุฏ ุงููููุฉ
                if (!isSilent) inputElement.value = ''; 
                messageElement.textContent = '';
                return;
            }
            
            let calculatedPercentage = 0;
            let calculatedPrice = 0;
            
            // Case 1: Input is Discount Percentage (%)
            if (mode === 'percent') {
                let percent = parseFloat(inputElement.value) || 0;
                
                // Validation: Must be between 0 and 100
                if (percent > 100) {
                    percent = 100;
                    inputElement.value = '100';
                    if (!isSilent) showNotification('โ๏ธ ูุณุจุฉ ุงูุฎุตู ูุง ูููู ุฃู ุชุชุฌุงูุฒ 100%. ุชู ุงูุชุนุฏูู ุชููุงุฆูุงู.', 'warning', 4000);
                } else if (percent < 0) {
                    percent = 0;
                    inputElement.value = '0';
                }
                
                calculatedPercentage = percent;
                calculatedPrice = calculateDiscountedPrice(originalPrice, calculatedPercentage);
                
                // ุชุญุฏูุซ ุญูู ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู ุจุตูุช
                priceInput.value = calculatedPrice.toFixed(2);
                
                messageElement.textContent = `ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู ูู: ${calculatedPrice.toFixed(2)} ${currency}`;
            } 
            
            // Case 2: Input is Price After Discount
            else if (mode === 'price-after') {
                let finalPrice = parseFloat(inputElement.value);
                
                if (isNaN(finalPrice)) {
                    messageElement.textContent = '';
                    percentInput.value = '0';
                    return;
                }

                // ๐ Validation/Auto-Correction: If finalPrice >= originalPrice
                if (finalPrice >= originalPrice) {
                    // ุชุตุญูุญ ุชููุงุฆู: ุงูุณุนุฑ ุงูุฃุตูู - 0.01 (ูุถูู ุฃูู ุฃูู)
                    const correctedPrice = Math.max(0.01, originalPrice - 0.01); 
                    inputElement.value = correctedPrice.toFixed(2);
                    finalPrice = correctedPrice;
                    
                    if (!isSilent) showNotification('โ๏ธ ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู ูุง ูููู ุฃู ูููู ุฃูุจุฑ ุฃู ูุณุงูู ุงูุณุนุฑ ุงูุฃุตูู. ุชู ุชุนุฏููู ุชููุงุฆูุงู.', 'warning', 6000);
                } else if (finalPrice < 0.01) {
                    finalPrice = 0.01;
                    inputElement.value = '0.01';
                }
                
                calculatedPrice = finalPrice;
                
                // Calculate the percentage
                const discountAmount = originalPrice - calculatedPrice;
                calculatedPercentage = (discountAmount / originalPrice) * 100;
                
                // ุชุญุฏูุซ ุญูู ุงููุณุจุฉ ุงููุฆููุฉ
                percentInput.value = calculatedPercentage.toFixed(2);
                
                messageElement.textContent = `ูุณุจุฉ ุงูุฎุตู ุงููุญุณูุจุฉ ูู: ${calculatedPercentage.toFixed(2)}%`;
            }
        }

        // ๐ ุฏุงูุฉ ุนุฑุถ ุงูููุชุฌุงุช ุชุชููู ูููุฉ ุงูุจุญุซ
        function renderProductList(searchTerm = '') {
            const listContainer = document.getElementById('product-list');
            listContainer.innerHTML = '';
            const allProductsRaw = loadProductsRaw();
            
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();

            const filteredProducts = allProductsRaw.filter(rawItem => {
                const product = getProductById(rawItem.id);
                if (!product || !product.name) return false;
                
                if (lowerCaseSearchTerm === '') return true; 
                
                // ุงูุจุญุซ ูู ุงูุงุณู ูุงููุตู (ุงููููุงุช ุงูููุชุงุญูุฉ)
                const nameMatches = product.name.toLowerCase().includes(lowerCaseSearchTerm);
                const descriptionMatches = product.description && product.description.toLowerCase().includes(lowerCaseSearchTerm);
                
                return nameMatches || descriptionMatches;
            });

            if (filteredProducts.length === 0) {
                listContainer.innerHTML = `<p style="text-align: center; padding: 20px; color: var(--light-primary);">ูุง ุชูุฌุฏ ููุชุฌุงุช ูุทุงุจูุฉ ููุชูุฌุฉ ุงูุจุญุซ "${searchTerm}".</p>`;
                return;
            }

            filteredProducts.forEach(rawItem => { 
                const product = getProductById(rawItem.id);
                if (!product || !product.name) return;
                
                // Discount Calculation and Display Logic
                const originalPrice = product.price;
                const discountPercentage = product.discount || 0;
                const finalPrice = calculateDiscountedPrice(originalPrice, discountPercentage);

                let priceDisplay;
                let discountBadge = '';

                if (discountPercentage > 0) {
                    priceDisplay = `
                        <div class="price-details">
                            <span class="original-price">${originalPrice.toFixed(2)} ${product.currency}</span>
                            <span class="discounted-price">${finalPrice.toFixed(2)} ${product.currency}</span>
                        </div>
                    `;
                    discountBadge = `<span class="discount-badge">ุฎุตู ${discountPercentage.toFixed(1).replace(/\.0$/, '')}%</span>`; // ุนุฑุถ ุงูุฎุตู ุจุฏูู .0
                } else {
                    // ุนุฑุถ ุงูุณุนุฑ ุงูุนุงุฏู ูุฃูู ุงูุณุนุฑ ุงููุฎุตูู ูุชูุญูุฏ ุงูุชูุณูู
                    priceDisplay = `
                        <div class="price-details">
                            <span class="discounted-price">${originalPrice.toFixed(2)} ${product.currency}</span>
                        </div>
                    `;
                }

                const item = document.createElement('div');
                item.className = 'product-item';
                item.innerHTML = `
                    <div class="item-details">
                        <img src="${product.image || 'placeholder.png'}" alt="${product.name}" 
                             style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-left: 10px;">
                        <strong>${product.name}</strong> 
                        ${discountBadge} ${priceDisplay} <span style="color: #999; font-size: 12px; margin-right: 15px;">ุงููุฆุฉ: ${product.type}</span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="editProduct('${product.id}')">
                            <i class="fas fa-pen"></i> ุชุนุฏูู
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">
                            <i class="fas fa-trash"></i> ุญุฐู
                        </button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }
        
        // ุฏุงูุฉ ุฅุนุฏุงุฏ ุงูุจุญุซ
        function setupSearchFilter() {
            const searchInput = document.getElementById('product-search');
            if (searchInput) {
                searchInput.addEventListener('input', (event) => {
                    // ููุชุฃูุฏ ูู ุนุฏู ุชุฌุงูุฒ ุงูู 20 ุญุฑูุงู
                    let searchTerm = event.target.value;
                    if (searchTerm.length > 20) {
                        searchTerm = searchTerm.substring(0, 20);
                        event.target.value = searchTerm; // ูุต ุงููููุฉ ูู ุงูุญูู
                    }
                    renderProductList(searchTerm);
                });
            }
        }
        
        // =======================================================
        //                      ุงููุถุน ุงููููู / ุงููุงุชุญ
        // =======================================================
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled'); // ุชูุถูู ุงููุถุน ูุจูู ูู localStorage
            document.getElementById('mode-toggle').innerHTML = isDark ? '<i class="fas fa-sun"></i> ุงููุถุน ุงููุงุชุญ' : '<i class="fas fa-moon"></i> ุงููุถุน ุงูุฏุงูู';
        }

        function applyInitialMode() {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('mode-toggle').innerHTML = '<i class="fas fa-sun"></i> ุงููุถุน ุงููุงุชุญ';
            } else {
                document.getElementById('mode-toggle').innerHTML = '<i class="fas fa-moon"></i> ุงููุถุน ุงูุฏุงูู';
            }
        }
        
        // =======================================================
        //                      ๐ ูุธุงุฆู ุฅุบูุงู ุงูููุงูุฐ ุงูููุจุซูุฉ ุจุงูุถุบุท ุนูู ุงููุงูุด
        // =======================================================

        function setupModalCloseOnMarginClick(modalId, closeAction) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.addEventListener('click', function(event) {
                    // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงูููุฑ ุนูู ุฎูููุฉ ุงูู modal ูููุณ ุฏุงุฎู ุงูุตูุฏูู ุงูุฏุงุฎูู
                    if (event.target === modal) {
                        closeAction();
                    }
                });
            }
        }
        
        function closeBackupConfirmationModal() {
             const modal = document.getElementById('backup-confirmation-modal');
             if (modal) {
                clearTimeout(countdownBackupTimer); // ุฅููุงู ุงูุนุฏ ุงูุชูุงุฒูู
                modal.style.display = 'none';
             }
             showNotification('ุชู ุฅูุบุงุก ุชุฃููุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.', 'info', 3000);
        }
        
        function closeLogoutConfirmationModal() {
             const modal = document.getElementById('logout-confirmation-modal');
             if (modal) modal.style.display = 'none';
        }
        
        function closePinModal() {
             const modal = document.getElementById('pin-modal');
             if (modal) modal.style.display = 'none';
             pendingActionData = null; // ุฅูุบุงุก ุงูุฅุฌุฑุงุก ุงููุนูู
             showNotification('ุชู ุฅูุบุงุก ุนูููุฉ ุงูุชุฃููุฏ.', 'info', 3000);
        }

        function closeBackupPromptModal() {
            const modal = document.getElementById('backup-prompt-modal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeDeleteConfirmationModal() {
            const modal = document.getElementById('delete-confirmation-modal');
            if (modal) modal.style.display = 'none';
            showNotification('ุชู ุฅูุบุงุก ุนูููุฉ ุงูุญุฐู.', 'info', 3000);
        }

        function setupMarginCloseListeners() {
            // ุดุงุดุฉ ุชุฃููุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ (ุนูุฏ ุงูุงุณุชุนุงุฏุฉ)
            setupModalCloseOnMarginClick('backup-confirmation-modal', closeBackupConfirmationModal);
            
            // ุดุงุดุฉ ุชุฃููุฏ ุชุณุฌูู ุงูุฎุฑูุฌ
            setupModalCloseOnMarginClick('logout-confirmation-modal', closeLogoutConfirmationModal);
            
            // ุดุงุดุฉ ุฑูุฒ ุงูุชุฃููุฏ (PIN)
            setupModalCloseOnMarginClick('pin-modal', closePinModal);
            
            // ุดุงุดุฉ ุทูุจ ุชูุฒูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจุนุฏ ุงูุญูุธ/ุงูุญุฐู
            setupModalCloseOnMarginClick('backup-prompt-modal', closeBackupPromptModal);
            
            // ๐ ุดุงุดุฉ ุชุฃููุฏ ุงูุญุฐู
            setupModalCloseOnMarginClick('delete-confirmation-modal', closeDeleteConfirmationModal);
        }


        // =======================================================
        //                      ุชููุฆุฉ ุงูุตูุญุฉ ูุงูุฃุญุฏุงุซ
        // =======================================================
        
        function initializePage() {
            applyInitialMode();
            setupImageModeSwitch(); 
            setupDiscountSwitch('percent'); // ๐ ุชููุฆุฉ ูุถุน ุฅุฏุฎุงู ุงูุฎุตู 
            renderProductList();
            setupInactivityTracking(); // ุจุฏุก ุชุชุจุน ุนุฏู ุงููุดุงุท ูุชูุนูู ูุคูุช ุงูุฌูุณุฉ
            setupSearchFilter(); 
            setupMarginCloseListeners(); // ๐ ุฅุนุฏุงุฏ ูุธููุฉ ุฅุบูุงู ุงูููุงูุฐ ุจุงูุถุบุท ุนูู ุงููุงูุด

            document.getElementById('product-form').addEventListener('submit', saveProduct);
            document.getElementById('mode-toggle').addEventListener('click', toggleDarkMode);

            // ๐ ุชูุนูู ุงูุชูููุฏ ุงูุชููุงุฆู ูููููุงุช ุงูููุชุงุญูุฉ ุนูุฏ ุชุบููุฑ ุงูุญููู ุงููุนููุฉ
            document.getElementById('product-name').addEventListener('input', generateKeywordsFromFields);
            document.getElementById('product-type').addEventListener('change', generateKeywordsFromFields);
            // ุชูุช ุฅุถุงูุฉ ุงููุณุชูุน ููุณุนุฑ ุงูุฃุตูู ุจุงููุนู ุฏุงุฎู setupDiscountSwitchุ ูููู ูุถูุงู ุงูุชุบุทูุฉ:
            document.getElementById('product-price').addEventListener('input', generateKeywordsFromFields); 
        }
        
        document.addEventListener('DOMContentLoaded', checkAuthentication);
    </script>
</body>
</html>